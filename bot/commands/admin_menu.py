import operator
from datetime import datetime, timedelta
from typing import Any

from aiogram import Router
from aiogram.types import Message, CallbackQuery
from aiogram_dialog import Window, Dialog, DialogManager, DialogProtocol, StartMode
from aiogram_dialog.widgets.input import MessageInput
from aiogram_dialog.widgets.kbd import Button, Column, Cancel, Select
from aiogram_dialog.widgets.text import Const, Format
from sqlalchemy import select, func

from app import dp
from commands.state_classes import AdminMenu, AccountMainPage, AdminRequestWatch, Comments, Answers
from core.constants import APP_TOKEN, LOGIN, PASSWORD, VALUES_STATUS
from core.text import dialogs
from models import AdminPassword, Request, User
from models.request import RequestStatus
from repositories.request_repository import request_repository
from utils.api_requests import init_session, get_info_ticket, kill_session, get_comments_for_ticket, \
    get_answers_for_ticket
from utils.database import db_async_session_manager
from utils.utils import check_password, create_url

admin_dialogs = dialogs['admin']
admin_router = Router(name='admin_router')


async def password_sent(message: Message, dialog: DialogProtocol, manager: DialogManager):
    async with db_async_session_manager() as session:
        hashed_password = await session.scalar(select(AdminPassword).where(AdminPassword.id == 1))
    if check_password(hashed_password.password, message.text):
        await message.delete()
        await manager.next()


async def insert_days(message: Message, dialog: DialogProtocol, manager: DialogManager):
    if message.text.isdigit():
        n = int(message.text)
        manager.dialog_data['days'] = n
        time_threshold = datetime.now() - timedelta(days=n)
        async with db_async_session_manager() as session:
            requests = await session.execute(
                select(Request).where(func.to_timestamp(func.extract('epoch', Request.created_at)) >= time_threshold)
            )
            requests = requests.scalars().all()
            for el in requests:
                print(vars(el))
            successful_requests = [el for el in requests if el.status == RequestStatus.SUCCESSFUL]
            escalation_requests = [el for el in requests if el.status == RequestStatus.ESCALATION]
            users = await session.execute(
                select(User).where(func.to_timestamp(func.extract('epoch', User.created_at)) >= time_threshold)
            )
            users = users.scalars().all()
            manager.dialog_data['new_users'] = len(users)
            manager.dialog_data['requests'] = len(requests)
            manager.dialog_data['successful_requests'] = len(successful_requests)
            manager.dialog_data['escalation_requests'] = len(escalation_requests)

        await manager.next()
    else:
        await message.answer("–û—Ç–ø—Ä–∞–≤—å—Ç–µ —á–∏—Å–ª–æ")


async def escalation_requests_start(callback, button, manager):
    await manager.start(AdminMenu.requests_choose)


async def main_menu(callback: CallbackQuery, button: Button,
                    manager: DialogManager):
    await manager.start(AccountMainPage.main, mode=StartMode.RESET_STACK)


async def on_request_selected(callback: CallbackQuery, widget: Any,
                              manager: DialogManager, item_id: str):
    request = manager.dialog_data['transition'][int(item_id)]
    manager.dialog_data['request'] = vars(request)
    index = manager.dialog_data['request']['system_id']
    # TODO: —Ç—É—Ç —Å–¥–µ–ª–∞–π –∑–∞–ø—Ä–æ—Å –≤ –∞–ø–∏—à–∫—É –ø–æ –ø–æ–≤–æ–¥—É —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏, –ø–æ–ª–æ–∂–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é status
    url_init = await create_url("init_session")
    url_info = await create_url("ticket_info", index)
    url_kill = await create_url("kill_session")
    token = (await init_session(url_init, APP_TOKEN, LOGIN, PASSWORD))["session_token"]
    state = (await get_info_ticket(url_info, APP_TOKEN, token))["status"]
    kill = await kill_session(url_kill, APP_TOKEN, token)
    status = VALUES_STATUS[state]
    manager.dialog_data['text'] = f"{manager.dialog_data['request']['question']}\n–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏: {status}"
    await manager.start(AdminRequestWatch.request_menu, data=manager.dialog_data)


async def start_answers(callback: CallbackQuery, button: Button,
                        manager: DialogManager):
    # TODO: –∑–∞–ø—Ä–æ—Å –≤ –∞–ø–∏ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã –∏ —Å–æ–µ–¥–∏–Ω—è–µ—Ç –∏—Ö
    lst = []
    lst.append(manager.start_data['request']['answer'])
    if manager.start_data['request']['status'] == RequestStatus.ESCALATION:
        index = manager.start_data['request']['system_id']
        url_init = await create_url("init_session")
        url_answers = await create_url("get_solution", index)  # TODO —Å—é–¥–∞ –≤–º–µ—Å—Ç–æ index id –∏–∑ –±–¥
        url_kill = await create_url("kill_session")
        token = (await init_session(url_init, APP_TOKEN, LOGIN, PASSWORD))["session_token"]
        answers = await get_answers_for_ticket(url_answers, APP_TOKEN,
                                               token)  # TODO –¢—É—Ç —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –æ—Ç–≤–µ—Ç–∞–º–∏ –≤ –∫–∞–∂–¥–æ–º —Å–ª–æ–≤–∞—Ä–µ –æ—Ç–≤–µ—Ç –≤ ["content"] –ª–µ–∂–∏—Ç, —Ç–∞–∫ —á—Ç–æ –Ω–∞–¥–æ –ø—Ä–∏–¥—É–º–∞—Ç—å —á—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ –º–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤
        kill = await kill_session(url_kill, APP_TOKEN, token)
        answer = "–û—Ç–≤–µ—Ç–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ"
        if answers:
            for el in answers:
                lst.append(el['content'])
            answer = "\n----------------------------------------\n".join(lst)
    else:
        answer = manager.dialog_data['request']['answer']
    await manager.start(Answers.answer_showing, data={"updated_answers": answer})


async def start_comments(callback: CallbackQuery, button: Button,
                         manager: DialogManager):
    if manager.start_data['request']['status'] == RequestStatus.ESCALATION:
        # TODO —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤, –ø–µ—Ä–µ–¥–µ–ª–∞–π –ø–æ–¥ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        index = manager.start_data['request']['system_id']
        url_init = await create_url("init_session")
        url_comment = await create_url("create_get_comment", index)
        url_kill = await create_url("kill_session")
        token = (await init_session(url_init, APP_TOKEN, LOGIN, PASSWORD))["session_token"]
        comments = await get_comments_for_ticket(url_comment, APP_TOKEN, token)
        kill = await kill_session(url_kill, APP_TOKEN, token)
        comment_text = "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç"
        if comments:
            comment_text = "\n----------------------------------------\n".join([el['content'] for el in comments])
    else:
        comment_text = "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç"
    await manager.start(Comments.comment_showing, data={'text': comment_text})


async def get_data(**kwargs):
    manager = kwargs['dialog_manager']
    async with db_async_session_manager() as session:
        requests_obj = await request_repository.get_escalated_requests(session)
        requests = []
        manager.dialog_data['transition'] = []
        for i, request in enumerate(requests_obj):
            manager.dialog_data['transition'].append(request)
            requests.append((request.question, i))
        return {
            "requests": requests,
            "count": len(requests),
        }


kbd = Select(
    Format("{item[0]}"),  # E.g `‚úì Apple (1/4)`
    id="s_request_questions",
    item_id_getter=operator.itemgetter(1),
    # each item is a tuple with id on a first position
    items="requests",  # we will use items from window data at a key `fruits`
    on_click=on_request_selected,
)
admin_dialog = Dialog(Window(
    Const(admin_dialogs['password']),
    Cancel(Const("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—éüè†")),
    MessageInput(password_sent),
    state=AdminMenu.admin_password
), Window(Const('–ó–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É?'), MessageInput(insert_days), state=AdminMenu.days),
    Window(Format(
        '–ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {dialog_data[new_users]}\n–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: {dialog_data[requests]}\n–£—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: {dialog_data[successful_requests]}\n–≠—Å–∫–∞–ª–∞—Ü–∏–π: {dialog_data[escalation_requests]}'),
        Column(
            Button(Const('–≠—Å–∫–∞–ª–∞—Ü–∏–æ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏'), id='escalation_requests', on_click=escalation_requests_start),
            Button(Const("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—éüè†"), id="main_menu", on_click=main_menu)),
        state=AdminMenu.admin_menu), Window(Const("–ó–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"),
                                            Column(kbd,
                                                   Cancel(Const("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—éüè†"))), state=AdminMenu.requests_choose,
                                            getter=get_data))
admin_request_watch = Dialog(Window(Format('{start_data[text]}'),
                                    Button(Const("–û—Ç–≤–µ—Ç—ã"), id='basdasd', on_click=start_answers),
                                    Button(Const("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∑–∞—è–≤–∫–µ"), id='someshi', on_click=start_comments),
                                    Cancel(Const("–ú–µ–Ω—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")), state=AdminRequestWatch.request_menu
                                    ))
dp.include_router(admin_request_watch)
dp.include_router(admin_dialog)
