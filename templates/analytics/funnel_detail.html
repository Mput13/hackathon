{% extends 'base.html' %}

{% block header_title %}{{ funnel.name }}{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{% url 'funnels_list' %}?version={{ funnel.version.id }}" class="text-indigo-600 hover:text-indigo-800 flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –≤–æ—Ä–æ–Ω–æ–∫
    </a>
</div>

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–æ—Ä–æ–Ω–∫–µ -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
    <div class="flex justify-between items-start mb-4">
        <div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">{{ funnel.name }}</h2>
            {% if funnel.description %}
            <p class="text-gray-600 mb-4">{{ funnel.description }}</p>
            {% endif %}
            <div class="flex items-center gap-2 text-sm text-gray-500">
                <span>–í–µ—Ä—Å–∏—è: <strong>{{ funnel.version.name }}</strong></span>
                <span>‚Ä¢</span>
                <span>{{ funnel.steps|length }} —à–∞–≥–æ–≤</span>
                {% if funnel.is_preset %}
                <span class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-xs">–ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –®–∞–≥–∏ –≤–æ—Ä–æ–Ω–∫–∏ -->
    <div class="mt-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">–®–∞–≥–∏ –≤–æ—Ä–æ–Ω–∫–∏</h3>
        <div class="space-y-3">
            {% for step in funnel.steps %}
            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                <div class="flex-shrink-0 w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">
                    {{ forloop.counter }}
                </div>
                <div class="flex-1">
                    <p class="font-medium text-gray-900">{{ step.name }}</p>
                    <p class="text-xs text-gray-500">
                        {% if step.type == 'goal' %}
                        üéØ –¶–µ–ª—å: {{ step.code }}
                        {% elif step.type == 'url' %}
                        üìç URL: {{ step.url }}
                        {% endif %}
                    </p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% if metrics %}
<!-- –ú–µ—Ç—Ä–∏–∫–∏ –≤–æ—Ä–æ–Ω–∫–∏ -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
    <h3 class="text-lg font-bold text-gray-800 mb-6">–ú–µ—Ç—Ä–∏–∫–∏ –≤–æ—Ä–æ–Ω–∫–∏</h3>
    
    <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-indigo-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600 mb-1">–í—Ö–æ–¥–æ–≤ –≤ –≤–æ—Ä–æ–Ω–∫—É</p>
            <p class="text-3xl font-bold text-indigo-600">{{ metrics.total_entered|default:0 }}</p>
        </div>
        <div class="bg-green-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600 mb-1">–ó–∞–≤–µ—Ä—à–∏–ª–∏ –≤–æ—Ä–æ–Ω–∫—É</p>
            <p class="text-3xl font-bold text-green-600">{{ metrics.total_completed|default:0 }}</p>
        </div>
        <div class="bg-purple-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600 mb-1">–û–±—â–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è</p>
            <p class="text-3xl font-bold {% if metrics.overall_conversion < 10 %}text-red-600{% elif metrics.overall_conversion < 20 %}text-yellow-600{% else %}text-purple-600{% endif %}">
                {{ metrics.overall_conversion|default:0 }}%
            </p>
        </div>
    </div>

    <!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ—Ä–æ–Ω–∫–∏ -->
    <div class="mb-6">
        <h4 class="text-md font-semibold text-gray-800 mb-4">–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω–≤–µ—Ä—Å–∏–∏</h4>
        <div class="space-y-4">
            {% for step_metric in metrics.step_metrics %}
            <div class="relative">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">
                            {{ step_metric.step_number }}
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">{{ step_metric.step_name }}</p>
                            <p class="text-xs text-gray-500">{{ step_metric.users_reached }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–æ—Å—Ç–∏–≥–ª–æ</p>
                        </div>
                    </div>
                    <div class="text-right">
                        {% if step_metric.step_number > 1 %}
                        <p class="text-sm font-semibold {% if step_metric.conversion_from_prev < 50 %}text-red-600{% elif step_metric.conversion_from_prev < 70 %}text-yellow-600{% else %}text-green-600{% endif %}">
                            {{ step_metric.conversion_from_prev }}%
                        </p>
                        <p class="text-xs text-gray-500">–∫–æ–Ω–≤–µ—Ä—Å–∏—è</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä -->
                {% if step_metric.step_number > 1 %}
                <div class="ml-13">
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full {% if step_metric.conversion_from_prev < 50 %}bg-red-500{% elif step_metric.conversion_from_prev < 70 %}bg-yellow-500{% else %}bg-green-500{% endif %}" 
                             style="width: {{ step_metric.conversion_from_prev }}%"></div>
                    </div>
                    {% if step_metric.drop_off > 0 %}
                    <p class="text-xs text-gray-500 mt-1">
                        –ü–æ—Ç–µ—Ä—è–Ω–æ: <span class="font-semibold text-red-600">{{ step_metric.drop_off }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span> 
                        ({{ step_metric.drop_off_percentage }}%)
                    </p>
                    {% endif %}
                </div>
                {% endif %}

                <!-- –°—Ç—Ä–µ–ª–∫–∞ –≤–Ω–∏–∑ (–∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —à–∞–≥–∞) -->
                {% if not forloop.last %}
                <div class="ml-13 mt-2 mb-2">
                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                    </svg>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- AI-–∞–Ω–∞–ª–∏–∑ -->
    {% if metrics.ai_analysis %}
    <div class="mt-6 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-lg">
        <div class="flex items-start gap-3">
            <svg class="w-6 h-6 text-indigo-600 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            <div class="flex-1">
                <h4 class="font-bold text-indigo-900 mb-2">ü§ñ AI-–∞–Ω–∞–ª–∏–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h4>
                <div class="text-sm text-gray-800 whitespace-pre-line">{{ metrics.ai_analysis }}</div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- –†–∞–∑–±–∏–≤–∫–∞ –ø–æ –∫–æ–≥–æ—Ä—Ç–∞–º -->
{% if has_cohort_metrics and cohort_breakdown %}
<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
    <h3 class="text-lg font-bold text-gray-800 mb-6">–ê–Ω–∞–ª–∏–∑ –ø–æ –∫–æ–≥–æ—Ä—Ç–∞–º</h3>
    
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-gray-50">
                    <th class="p-4 text-xs font-medium text-gray-500 uppercase tracking-wider">–ö–æ–≥–æ—Ä—Ç–∞</th>
                    <th class="p-4 text-xs font-medium text-gray-500 uppercase tracking-wider">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</th>
                    <th class="p-4 text-xs font-medium text-gray-500 uppercase tracking-wider">–í–æ—à–ª–∏ –≤ –≤–æ—Ä–æ–Ω–∫—É</th>
                    <th class="p-4 text-xs font-medium text-gray-500 uppercase tracking-wider">–ó–∞–≤–µ—Ä—à–∏–ª–∏</th>
                    <th class="p-4 text-xs font-medium text-gray-500 uppercase tracking-wider">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</th>
                    <th class="p-4 text-xs font-medium text-gray-500 uppercase tracking-wider">AI-–∞–Ω–∞–ª–∏–∑</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for cohort_id, cohort_data in cohort_breakdown.items %}
                <tr class="hover:bg-gray-50">
                    <td class="p-4 font-medium text-gray-900">{{ cohort_data.cohort_name }}</td>
                    <td class="p-4 text-gray-600">{{ cohort_data.users_in_cohort }}</td>
                    <td class="p-4 text-gray-600">{{ cohort_data.users_entered_funnel }}</td>
                    <td class="p-4 text-gray-600">{{ cohort_data.users_completed_funnel }}</td>
                    <td class="p-4">
                        <span class="px-3 py-1 rounded-full text-sm font-semibold {% if cohort_data.conversion_rate < 10 %}bg-red-100 text-red-700{% elif cohort_data.conversion_rate < 20 %}bg-yellow-100 text-yellow-700{% else %}bg-green-100 text-green-700{% endif %}">
                            {{ cohort_data.conversion_rate }}%
                        </span>
                    </td>
                    <td class="p-4 text-sm text-gray-600">
                        {% if cohort_data.ai_analysis %}
                        <div class="bg-indigo-50 p-2 rounded text-indigo-900 border border-indigo-100 text-xs">
                            {{ cohort_data.ai_analysis|truncatechars:150 }}
                        </div>
                        {% else %}
                        <span class="text-gray-400 italic">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% elif has_cohort_metrics %}
<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <p class="text-sm text-yellow-800">
            ‚ö†Ô∏è –†–∞–∑–±–∏–≤–∫–∞ –ø–æ –∫–æ–≥–æ—Ä—Ç–∞–º –µ—â–µ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É —Å —Ñ–ª–∞–≥–æ–º <code class="bg-yellow-100 px-1 rounded">--by-cohorts</code>
        </p>
    </div>
</div>
{% endif %}

{% else %}
<!-- –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
    <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
    </svg>
    <h3 class="text-xl font-bold text-gray-800 mb-2">–ú–µ—Ç—Ä–∏–∫–∏ –µ—â–µ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã</h3>
    <p class="text-gray-600 mb-6">–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Ç—Ä–∏–∫ —ç—Ç–æ–π –≤–æ—Ä–æ–Ω–∫–∏.</p>
    <div class="bg-gray-50 p-4 rounded-lg text-left max-w-2xl mx-auto">
        <code class="block bg-gray-800 text-green-400 p-3 rounded text-sm">
            docker-compose exec web python manage.py calculate_funnels --version "{{ funnel.version.name }}" --funnel-id {{ funnel.id }}
        </code>
    </div>
</div>
{% endif %}
{% endblock %}

